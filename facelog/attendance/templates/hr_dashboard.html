{% extends 'base.html' %}

{% block start %}

<body class="vh-100 d-flex flex-column">

    <!-- Main Content (Sidebar + Detail View) -->
    <div class="container-fluid flex-grow-1 d-flex h-100">

        <!-- Left Sidebar -->
        <div class="col-md-3 bg-blue p-3 border-end overflow-auto" id="sidebar">
            <ul class="nav nav-pills flex-column">
                <li class="nav-item">
                    <a class="nav-link active" id="attendance-tab" data-bs-toggle="pill" href="#attendance"
                        onclick="showContent('Attendance')">Attendance</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="employees-tab" data-bs-toggle="pill" href="#employees"
                        onclick="showContent('Employees')">Employees</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" id="add-employee-tab" data-bs-toggle="pill" href="#add-employee"
                        onclick="showContent('Add employee')">Add Employee</a>
                </li>
            </ul>
        </div>

        <!-- Right Side (Detail Page) -->
        <div class="col-md-9 p-4 bg-light" id="content-area">
            <!-- Tab content will be injected here dynamically -->
            <div class="tab-content" id="myTabContent">
                <div class="tab-pane fade show active" id="attendance">
                    <h3>Loading Attendance Records...</h3>
                </div>
                <div class="tab-pane fade" id="employees">
                    <h3>Loading Employee List...</h3>
                </div>
                <div class="tab-pane fade" id="add-employee">
                    <h3>Add Employee</h3>
                    <form id="employeeForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <label>Name:</label>
                        <input type="text" name="name" required class="form-control mb-2">

                        <label>Emp ID:</label>
                        <input type="text" name="emp_id" required class="form-control mb-2">

                        <label>Designation:</label>
                        <input type="text" name="designation" required class="form-control mb-2">

                        <label>Image:</label>
                        <input type="file" name="image" class="form-control mb-2">

                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                </div>
            </div>
        </div>

    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- JavaScript for Dynamic Content Update -->
    <script>
        function showContent(option) {
            let contentArea = document.getElementById("content-area");

            if (option === "Attendance") {
                contentArea.innerHTML = `
                    <h3>Loading Attendance Records...</h3>
                `;
                fetch("/api/attendance_list/")
                    .then(response => response.json())
                    .then(data => {
                        let tableHtml = `
                            <h3>Attendance Records</h3>
                            <!-- Search and Filter -->
                            <div class="mb-3">
                                <input type="text" id="search-input" class="form-control mb-3" placeholder="Search by Employee Name">
                                <select id="filter-date" class="form-select">
                                    <option value="today">Today</option>
                                    <option value="yesterday">Yesterday</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <input type="date" id="custom-date" class="form-control mt-2" style="display: none;">
                                <button class="btn btn-secondary mt-2" onclick="downloadCSV()">Download CSV</button>
                            </div>
                            <table class="table table-bordered table-striped">
                                <thead class="thead-dark">
                                    <tr>
                                        <th>Employee ID</th>
                                        <th>Employee Name</th>
                                        <th>Date</th>
                                        <th>Time</th>
                                    </tr>
                                </thead>
                                <tbody id="attendance-table-body">
                        `;

                        if (data.attendances.length === 0) {
                            tableHtml += `<tr><td colspan="4" class="text-center">No attendance records found.</td></tr>`;
                        } else {
                            data.attendances.forEach(record => {
                                tableHtml += `
                                    <tr>
                                        <td>${record.id}</td>
                                        <td>${record.name}</td>
                                        <td>${record.timestamp.split(" ")[0]}</td>
                                        <td>${record.timestamp.split(" ")[1]}</td>
                                    </tr>
                                `;
                            });
                        }

                        tableHtml += `</tbody></table>`;
                        contentArea.innerHTML = tableHtml;

                        // Filter and Search Functionality
                        const searchInput = document.getElementById("search-input");
                        const filterDate = document.getElementById("filter-date");
                        const customDate = document.getElementById("custom-date");
                        const tableBody = document.getElementById("attendance-table-body");

                        searchInput.addEventListener("input", filterRecords);
                        filterDate.addEventListener("change", filterRecords);
                        customDate.addEventListener("change", filterRecords);

                        function filterRecords() {
                            const searchValue = searchInput.value.toLowerCase();
                            const filterValue = filterDate.value;
                            const customDateValue = customDate.value;

                            let filteredData = data.attendances.filter(record => {
                                const nameMatch = record.name.toLowerCase().includes(searchValue);
                                let dateMatch = true;

                                if (filterValue === "custom" && customDateValue) {
                                    dateMatch = record.timestamp.startsWith(customDateValue);
                                } else if (filterValue !== "custom") {
                                    const recordDate = record.timestamp.split(" ")[0];
                                    const today = new Date().toISOString().split("T")[0];
                                    const yesterday = new Date(Date.now() - 864e5).toISOString().split("T")[0];

                                    if (filterValue === "today") {
                                        dateMatch = recordDate === today;
                                    } else if (filterValue === "yesterday") {
                                        dateMatch = recordDate === yesterday;
                                    }
                                }

                                return nameMatch && dateMatch;
                            });

                            renderFilteredTable(filteredData);
                        }

                        function renderFilteredTable(filteredData) {
                            tableBody.innerHTML = '';
                            filteredData.forEach(record => {
                                tableBody.innerHTML += `
                                    <tr>
                                        <td>${record.id}</td>
                                        <td>${record.name}</td>
                                        <td>${record.timestamp.split(" ")[0]}</td>
                                        <td>${record.timestamp.split(" ")[1]}</td>
                                    </tr>
                                `;
                            });
                        }

                        // CSV Download functionality
                        window.downloadCSV = function () {
                            const rows = [["Employee ID", "Employee Name", "Date", "Time"]];
                            data.attendances.forEach(record => {
                                rows.push([record.id, record.name, record.timestamp.split(" ")[0], record.timestamp.split(" ")[1]]);
                            });

                            const csvContent = rows.map(e => e.join(",")).join("\n");
                            const blob = new Blob([csvContent], { type: "text/csv;charset=utf-8;" });
                            const link = document.createElement("a");
                            link.setAttribute("href", URL.createObjectURL(blob));
                            link.setAttribute("download", "attendance_records.csv");
                            link.click();
                        }
                    })
                    .catch(error => {
                        contentArea.innerHTML = `<p class="text-danger">Error loading attendance records.</p>`;
                    });
            } else if (option === "Employees") {
                contentArea.innerHTML = `
                    <h3>Loading Employee List...</h3>
                `;
                fetch("/api/employees/")
                    .then(response => response.json())
                    .then(data => {
                        let employeesHtml = `
                            <h3>Employee List</h3>
                            <div class="row">
                        `;
                        data.employees.forEach(emp => {
                            employeesHtml += `
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card shadow-sm">
                                        <img src="${emp.image_url}" class="card-img-top img-fluid rounded" alt="${emp.name}" style="width: 150px; height: 150px;">
                                        <div class="card-body">
                                            <h5 class="card-title">${emp.name}</h5>
                                            <p class="card-text text-muted">${emp.designation}</p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        employeesHtml += "</div>";  // Close row div
                        contentArea.innerHTML = employeesHtml;
                    })
                    .catch(error => {
                        contentArea.innerHTML = `<p>Error loading employees.</p>`;
                    });
            } else if (option === "Add employee") {
                contentArea.innerHTML = `
                    <h3>Add Employee</h3>
                    <form id="employeeForm" enctype="multipart/form-data">
                        {% csrf_token %}
                        <label>Name:</label>
                        <input type="text" name="name" required class="form-control mb-2">
    
                        <label>Emp ID:</label>
                        <input type="text" name="emp_id" required class="form-control mb-2">
    
                        <label>Designation:</label>
                        <input type="text" name="designation" required class="form-control mb-2">
    
                        <label>Image:</label>
                        <input type="file" name="image" class="form-control mb-2">
    
                        <button type="submit" class="btn btn-primary">Submit</button>
                    </form>
                `;
            }
        }
    </script>

</body>
{% endblock %}